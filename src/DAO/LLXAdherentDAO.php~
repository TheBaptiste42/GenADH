<?php

namespace GenADH\DAO;

use GenADH\Domain\Adherent;
use GenADH\Domain\User;

class LLXAdherentDAO extends DAO
{
    
	public function find($id) {
		$sql = "select * from llx_adherent where rowid=?";
		$row = $this->getDb()->fetchAssoc($sql, array($id));

		if ($row)
			return $this->buildDomainObject($row);
		else
			return null;
	}  
	
	
	public function save(Adherent $adherent, User $usernow) {
			$datenow = date("Y-m-d H:i:s");
			$adherentData = array(
				'adh_civilite' => $adherent->getCivilite(),
				'adh_nom' => $adherent->getNom(),
				'adh_prenom' => $adherent->getPrenom(),
				'adh_groupe' => $adherent->getGroupe(),
				'adh_adresse' => $adherent->getAdresse(),
				'adh_codepostal' => $adherent->getCodePostal(),
				'adh_ville' => $adherent->getVille(),
				'adh_departement' => $adherent->getDepartement(),
				'adh_pays' => $adherent->getPays(),
				'adh_email' => $adherent->getEmail(),
				'adh_phone' => $adherent->getPhone(),
				'adh_mobile' => $adherent->getMobile(),
				'adh_datenaiss' => $adherent->getDateNaiss(),
				'adh_datelastmod' => $datenow,
				'int_user_lastmodauteur' => $usernow->getId(),
				'adh_isajour' => $adherent->getIsajour()
			);
			if ($adherent->getId()) {
				
				$this->getDb()->update('t_adherent_cop', $adherentData, array('adh_id' => $adherent->getId()));
			} else {
				$adherentData2 = array(
					'adh_datecreation' => $datenow,
					'int_user_auteur' => $usernow->getId()
				);
				$adherentDatatot = $adherentData + $adherentData2;
				$this->getDb()->insert('t_adherent', $adherentDatatot);
				
				$id = $this->getDb()->lastInsertId();
				$adherent->setId($id);
			}
	}
	

    /**
     * Creates an Article object based on a DB row.
     *
     * @param array $row The DB row containing Article data.
     * @return \MicroCMS\Domain\Article
     */
    protected function buildDomainObject($row) {
        $adherent = new Adherent();
        $adherent->setCivilite("M");
        $adherent->setNom($row['nom']);
        $adherent->setPrenom($row['prenom']);
        $adherent->setGroupe(1);
        $adherent->setAdresse($row['adresse']);
        $adherent->setCodePostal($row['cp']);
        $adherent->setVille(ucfirst(strtolower($row['ville'])));
        if ($row['cp'] != null && substr($row['cp'],0,2) == "59") {
        	$adherent->setDepartement("Nord");
        } elseif ($row['cp'] != null && substr($row['cp'],0,2) == "62") {
        	$adherent->setDepartement("Pas de Calais");
        } elseif ($row['cp'] == null) {
        	$adherent->setDepartement("");
        } else {
        	$adherent->setDepartement("NANANA");
        }
        $adherent->setPays("France");
        $adherent->setEmail($row['email']);
        $adherent->setPhone($row['phone_perso']);
        $adherent->setMobile($row['phone_mobile']);
        $adherent->setDateNaiss("1000-01-01");
        $adherent->setIsajour("0");
;
        return $adherent;
    }
}
